{% extends 'base.html' %}
{% load i18n static bootstrap4 fb_versions %}

{% block bootstrap4_extra_head %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'css/photomap.css' %}"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

<script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"
   integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q=="
   crossorigin=""></script>

<script>
function resizeMap() {
    var height = $(window).height() - 250;
    $('#mapid').height(height);
    mymap.invalidateSize();
}

$(document).ready(function(){

    mymap = new L.Map('mapid').setView([{{ photo_list.0.latitude }}, {{ photo_list.0.longitude }}], 10);

    var accessToken = 'pk.eyJ1IjoiY3dpZWdhbmQiLCJhIjoiY2pqdTU5N3BoNzM1dDN3bzN4bjM1b2NsYyJ9.ocaLNEeXel3a3to17zTMuQ';
    var tiles = new L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: 'mapbox.streets',
        accessToken: accessToken
    }).addTo(mymap);

    {% for photo in photo_list %}
        var map_icon = L.icon({
            iconUrl: '{% version photo.imagefile 'admin_thumbnail' %}',
            iconAnchor:   [16, 16], // point of the icon which will correspond to marker's location
        });
        var marker = L.marker(
            [{{ photo.latitude }}, {{ photo.longitude }}],
            { icon: map_icon }
        ).addTo(mymap).on('click', function(e) {
            var props = e.target.properties;
            $('#id_photo_name').html(props.name);
            $('#id_photo_file').attr('src', props.url);
            $('#id_photo_file').attr('alt', props.name);
            $('#photoModal').modal();
            //alert(props.url);
        });
        marker.properties = {};
        marker.properties.id = {{ photo.id }};
        marker.properties.name = "{{ photo.name }}";
        marker.properties.url = "{{ photo.imagefile.url }}";
    {% endfor %}

    resizeMap();
    window.onresize = function() {
        resizeMap();
    }
});
</script>
{% endblock %}

{% block title %}{% trans 'Map' %}{% endblock %}

{% block content %}
<!-- The Modal -->
<div class="modal fade" id="photoModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h4 id="id_photo_name" class="modal-title">Test</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>

            <!-- Modal body -->
            <div class="modal-body">
                <img id="id_photo_file" src="" alt="" width="100%">
            </div>

        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col">
            <div id="mapid" style="height: 200px; width: 100%;"></div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <br/>
            <a href="{% url 'photolist' %}{{ query_param }}" title="{% trans 'back' %}">
                <button class="btn btn-primary" type="link">
                    <i class="fal fa-check"></i>
                </button>
            </a>
        </div>
    </div>

</div>
{% endblock %}
